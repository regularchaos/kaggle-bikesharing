```{r, echo=FALSE, message = FALSE, warning = FALSE}
library(formatR)
```
---
title: "Kaggle - Bike Sharing Demand"
author: "Michael Fischer"
date: "March 31, 2015"
output: html_document
---

# Forecast use of a city bikeshare system

Bike sharing systems are a means of renting bicycles where the process of obtaining membership, rental, and bike return is automated via a network of kiosk locations throughout a city. Using these systems, people are able rent a bike from a one location and return it to a different place on an as-needed basis. Currently, there are over 500 bike-sharing programs around the world.

The data generated by these systems makes them attractive for researchers because the duration of travel, departure location, arrival location, and time elapsed is explicitly recorded. Bike sharing systems therefore function as a sensor network, which can be used for studying mobility in a city. In this competition, participants are asked to combine historical usage patterns with weather data in order to forecast bike rental demand in the Capital Bikeshare program in Washington, D.C.

You are provided hourly rental data spanning two years. For this competition, the training set is comprised of the first 19 days of each month, while the test set is the 20th to the end of the month. You must predict the total count of bikes rented during each hour covered by the test set, using only information available prior to the rental period.

![](bikes.png)

Data Fields

* datetime - hourly date + timestamp
* season -  1 = spring, 2 = summer, 3 = fall, 4 = winter 
* holiday - whether the day is considered a holiday
* workingday - whether the day is neither a weekend nor holiday
* weather - 
 + 1: Clear, Few clouds, Partly cloudy, Partly cloudy 
 + 2: Mist + Cloudy, Mist + Broken clouds, Mist + Few clouds, Mist 
 + 3: Light Snow, Light Rain + Thunderstorm + Scattered clouds, Light Rain + Scattered clouds 
 + 4: Heavy Rain + Ice Pallets + Thunderstorm + Mist, Snow + Fog 
* temp - temperature in Celsius
* atemp - "feels like" temperature in Celsius
* humidity - relative humidity
* windspeed - wind speed
* casual - number of non-registered user rentals initiated
* registered - number of registered user rentals initiated
* count - number of total rentals

```{r, message = FALSE, warning = FALSE}
## Load Packages ##
library(ggplot2) # Graphics
library(Metrics) # For the Root Mean Squared Log Error (RMSLE) function
library(randomForest) # Random Forest
```

Load the training data from the Bike Sharing data set.

```{r}
## Load Training Data ##
trainRaw <- read.csv('train.csv', header = TRUE, stringsAsFactors = FALSE)
```

To optimize our predictions, we need to engineer some of the built in data. First, we will modfiy `$datetime` to have year, month, weekday, and hour.

```{r}
## Feature Engineering Function ##
addFeatures <- function(df){
  names <- c("season","holiday","workingday","weather")
  df[,names] <- lapply(df[,names],factor)
  
  df$datetime <- as.character(df$datetime)
  df$datetime <- strptime(df$datetime, format="%Y-%m-%d %T", tz = "EST")
  
  df$hour <- as.integer(substr(df$datetime, 12, 13))
  df$hour <- as.factor(df$hour)
  
  df$weekday <- as.factor(weekdays(df$datetime))
  df$weekday <- factor(df$weekday, 
                       levels = c("Monday",
                                  "Tuesday",
                                  "Wednesday",
                                  "Thursday",
                                  "Friday",
                                  "Saturday",
                                  "Sunday"))

  df$month <- as.integer(substr(df$datetime,6,7))
  df$month <- as.factor(df$month)
  
  df$year <- as.integer(substr(df$datetime,1,4))
  df$year <- as.factor(df$year)

  #df$yearmonth<-as.factor(format(df$datetime,"%Y%m",tz="EST"))
  df <- subset(df, select = -c(datetime))
  
  df$weather[df$weather == 4] <- 3
  
  df <- df[c('year','month','weekday','hour','workingday','holiday',
             'season','weather','temp','atemp','humidity','windspeed',
             'casual','registered','count')]
  
  return(df)
}
```

Apply the feature engineering function to the training data:
```{r}
trainData <- addFeatures(trainRaw)
```

Lets see what we are working with by using `head(trainData)`.
```{r, echo=FALSE}
head(trainData)
```

Looking at the fields, we want to determine which have a correlation to bike usage.

```{r, fig.height=4,fig.width=7}
## Year Data Visualization
YearCasual = aggregate(casual ~ hour + year, data = trainData, FUN = "mean")
YearRegistered = aggregate(registered ~ hour + year, data = trainData, FUN = "mean")
par(mfrow=c(1,2))
ggplot(YearCasual, aes(x = hour, y = casual)) + 
  geom_line(aes(group = year, color = year), size = 2, alpha = 0.5)
ggplot(YearRegistered, aes(x = hour, y = registered)) + 
  geom_line(aes(group = year, color = year), size = 2, alpha = 0.5)
```

Clearly, ridership increased from 2011 to 2012. This needs to be taken into account when calculating predictions.

```{r, fig.height=4,fig.width=7}
## Weekday Data Visualization
WeekHourCount = aggregate(count ~ hour + weekday, data = trainData, FUN = "mean")
ggplot(WeekHourCount, aes(x=hour, y=count)) + 
  geom_line(aes(group=weekday, color=weekday),size=2,alpha=0.5)
ggplot(WeekHourCount, aes(x=hour, y=weekday)) + 
  geom_tile(aes(fill = count))+ 
  scale_fill_gradient(low="blue", high="red")
WeekHourCasual = aggregate(casual ~ hour + weekday, data = trainData, FUN = "mean")
ggplot(WeekHourCasual, aes(x=hour, y=casual)) + 
  geom_line(aes(group=weekday, color=weekday),size=2,alpha=0.5)
ggplot(WeekHourCasual, aes(x=hour, y=weekday)) + 
  geom_tile(aes(fill = casual)) + 
  scale_fill_gradient(low="blue", high="red")
WeekHourRegistered = aggregate(registered ~ hour + weekday, data = trainData, FUN = "mean")
ggplot(WeekHourRegistered, aes(x=hour, y=registered)) + 
  geom_line(aes(group=weekday, color=weekday),size=2,alpha=0.5)
ggplot(WeekHourRegistered, aes(x=hour, y=weekday)) + 
  geom_tile(aes(fill = registered)) + 
  scale_fill_gradient(low="blue", high="red")
```

Weekend vs weekday a strong correlation to the rider counts between casual and regestered. We can simplify the modeling to use the single flag of workingday instead of correlating to weekday.

```{r}
## Holiday Data Visualization
HolidayCasual = aggregate(casual ~ hour + holiday, data = trainData, FUN = "mean")
ggplot(HolidayCasual, aes(x = hour, y = casual)) + 
  geom_line(aes(group = holiday, color = holiday), size = 2, alpha = 0.5)
HolidayRegistered = aggregate(registered ~ hour + holiday, data = trainData, FUN = "mean")
ggplot(HolidayRegistered, aes(x = hour, y = registered)) + 
  geom_line(aes(group = holiday, color = holiday), size = 2, alpha = 0.5)
```

Weather indicates strong correlation (logically).

```{r}
## Season Data Visualization
SeasonCasual = aggregate(casual ~ hour + season, data = trainData, FUN = "mean")
ggplot(SeasonCasual, aes(x= hour, y = casual)) + 
  geom_line(aes(group = season, color = season), size = 2, alpha = 0.5)
SeasonRegistered = aggregate(registered ~ hour + season , data = trainData, FUN = "mean")
ggplot(SeasonRegistered, aes(x= hour, y = registered)) + 
  geom_line(aes(group = season, color = season), size = 2, alpha = 0.5)
```

```{r}
## Weather Data Visualization
WeatherCasual = aggregate(casual ~ hour + weather, data = trainData, FUN = "mean")
ggplot(WeatherCasual, aes(x= hour, y = casual)) + 
  geom_line(aes(group = weather, color = weather), size = 2, alpha = 0.5)
WeatherRegistered = aggregate(registered ~ hour + weather , data = trainData, FUN = "mean")
ggplot(WeatherRegistered, aes(x= hour, y = registered)) + 
  geom_line(aes(group = weather, color = weather), size = 2, alpha = 0.5)
```

```{r}
## Temperature Visulization
ggplot(trainData, aes(x = temp, y = casual)) + geom_jitter(aes(group = season, color = season))
ggplot(trainData, aes(x = temp, y = registered)) + geom_jitter(aes(group = season, color = season))
ggplot(trainData, aes(x = atemp, y = casual)) + geom_jitter(aes(group = season, color = season))
ggplot(trainData, aes(x = atemp, y = registered)) + geom_jitter(aes(group = season, color = season))
```

```{r}
## Humidity Visulization
ggplot(trainData, aes(x = humidity, y = casual)) + geom_jitter(aes(group = season, color = season))
ggplot(trainData, aes(x = humidity, y = registered)) + geom_jitter(aes(group = season, color = season))

aTempHumidityCount = aggregate(count ~ atemp + humidity, data = trainData, FUN = "mean")
ggplot(aTempHumidityCount, aes(x=atemp, y=humidity)) + 
  geom_tile(aes(fill = count))+ 
  scale_fill_gradient(low="blue", high="red")
aTempHumidityCasual = aggregate(casual ~ atemp + humidity, data = trainData, FUN = "mean")
ggplot(aTempHumidityCasual, aes(x=atemp, y=humidity)) + 
  geom_tile(aes(fill = casual))+ 
  scale_fill_gradient(low="blue", high="red")
aTempHumidityRegistered = aggregate(registered ~ atemp + humidity, data = trainData, FUN = "mean")
ggplot(aTempHumidityRegistered, aes(x=atemp, y=humidity)) + 
  geom_tile(aes(fill = registered))+ 
  scale_fill_gradient(low="blue", high="red")
```

```{r}
## Temperature and Humidity correlation with season and weather 
ggplot(trainData, aes(x = humidity)) + geom_density(aes(group = season, color = season), size = 2, alpha = 0.5)
ggplot(trainData, aes(x = humidity)) + geom_density(aes(group = weather, color = weather), size = 2, alpha = 0.5)
ggplot(trainData, aes(x = atemp)) + geom_density(aes(group = season, color = season), size = 2, alpha = 0.5)
ggplot(trainData, aes(x = atemp)) + geom_density(aes(group = weather, color = weather), size = 2, alpha = 0.5)
```

```{r}
## Windspeed Visulization
ggplot(trainData, aes(x = windspeed, y = casual)) + geom_jitter(aes(group = season, color = season))
ggplot(trainData, aes(x = windspeed, y = registered)) + geom_jitter(aes(group = season, color = season))
```

Our prediction method will be a Random Forest

```{r}
## Prediction Algorithm
ind <- sample(c(1:nrow(trainData)),2500) # random 1/4 sample, 3/4 to train, 1/4 to test the method on
trainSubset <- trainData[-ind,]
trainTest  <- trainData[ind,]

trainCasual <- subset(trainSubset, select = -c(count,registered))
trainRegistered <- subset(trainSubset, select = -c(count,casual))
```

```{r}
rfNtree <- 501
rfMtry  <- 5
rfImportance <- TRUE
set.seed(21)
```

```{r}
casualFit <- randomForest(casual ~., data = trainCasual, 
                          ntree = rfNtree, mtry = rfMtry, importance = rfImportance)
varImpPlot(casualFit)
```

```{r}
registeredFit <- randomForest(registered ~., data = trainRegistered, 
                          ntree = rfNtree, mtry = rfMtry, importance = rfImportance)
varImpPlot(registeredFit)
```

Casual Fit, in order of %IncMSE:
Hour, year, humidity, temp, atemp, month, workingday, weather, windspeed, casualdayflag, weekday, holiday, season
Registered Fit:
Hour, year, weather, month, workingday, humidity, season, weekday, temp, atemp, casualdayflag, windspeed, holiday

```{r}
casualFormula <- casual ~ hour + year + humidity + atemp + month + weekday
casualFit <- randomForest(casualFormula, data = trainCasual, 
                          ntree = rfNtree, importance = rfImportance)
registeredFormula <- registered ~ hour + year + humidity + atemp + month + weekday
registeredFit <- randomForest(registeredFormula, data = trainRegistered, 
                          ntree = rfNtree, importance = rfImportance)
```

```{r}
## Evaluate predicions
trainCasual$casualpred <- predict(casualFit,trainCasual)
trainTest$casualpred <- predict(casualFit,trainTest)
errCasualTrain = rmsle(trainCasual$casual, trainCasual$casualpred)
errCasualTrain
errCasualTest = rmsle(trainTest$casual, trainTest$casualpred)
errCasualTest
trainRegistered$registeredpred <- predict(registeredFit,trainRegistered)
trainTest$registeredpred <- predict(registeredFit,trainTest)
errRegisteredTrain = rmsle(trainRegistered$registered, trainRegistered$registeredpred)
errRegisteredTrain
errRegisteredTest = rmsle(trainTest$registered, trainTest$registeredpred)
errRegisteredTest
trainSubset$countpred <- round(trainCasual$casualpred + trainRegistered$registeredpred,0)
errCountTrain = rmsle(trainSubset$count, trainSubset$countpred)
errCountTrain
trainTest$countpred <- round(trainTest$casualpred + trainTest$registeredpred,0)
errCountTest = rmsle(trainTest$count, trainTest$countpred)
errCountTest
```